<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Drive Case Document Search</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="container">
    <h1>Document Checklist Automation</h1>

    <!-- Step 1 -->
    <section id="section1">
      <h2>Step 1: Provide Folder Link</h2>
      <input type="text" id="folder_link" placeholder="Enter Google Drive Folder Link">

      <h2>Step 2: Upload Excel OR provide Google Sheet link</h2>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input type="file" id="excel_file" accept=".xlsx">
        <input type="text" id="gsheet_link" placeholder="Or paste Google Sheet link (optional)" style="flex:1;">
        <button onclick="uploadSheetOrExcel()">Upload / Load</button>
      </div>

      <p style="font-size: 0.9rem; color:#bdbdbd; margin-top:6px;">Either upload an .xlsx or paste a Google Sheet link.
        The app will read headers from whichever you provide.</p>
    </section>

    <!-- Step 2 -->
    <section id="section2" style="display:none;">
      <h2>Step 3: Select Borrower Column & Start Scan</h2>
      <select id="borrower_col"></select>
      <button onclick="startFolderScan()">Start Folder Scan</button>
      <div id="folder_structure" style="margin-top:12px;"></div>

      <h3 style="margin-top:20px;">Live Scan Results</h3>
      <div id="scan_results"></div>
    </section>

    <!-- Step 3 -->
    <section id="section3" style="display:none;">
      <h2>Step 4: Select Case Type</h2>

      <div style="display:flex; gap:8px; align-items:center;">
        <select id="case_type">
          <option value="">-- Select --</option>
          {% for c in CASE_TYPES.keys() %}
          <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>

        <button id="add_case_type_btn" onclick="promptAddCaseType()">+ Add Case Type</button>
        <button id="edit_case_type_btn" onclick="promptEditCaseType()" style="background:#f0ad4e;">Edit Case
          Type</button>
      </div>

      <div id="case_docs_area" style="margin-top:16px; display:none;">
        <h3>Documents for selected case type</h3>
        <div id="docs_list"></div>
        <div style="margin-top:10px;">
          <button onclick="openAddDocumentModal()">+ Add Document</button>
        </div>
      </div>

      <table id="doc_table" style="display:none;">
        <thead>
          <tr>
            <th>Select</th>
            <th>Document</th>
            <th>Pattern</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Step 4 -->
    <section id="section4" style="display:none;">
      <h2>Step 5: Run Matching</h2>
      
      <button id="runBtn" onclick="prepareDocsThenRun()">Run</button>
      <div class="progress">
        <div class="bar" id="progress_bar"></div>
      </div>
    </section>

    <!-- OCR BUTTON -->
    <div style="margin-top:20px; text-align:center;">
      <button onclick="window.location.href='/tool'" id="ocr_btn" style="display:none;">
        Go for OCR SCAN
      </button>
    </div>
  </div>

  <!-- ========================================
       MODALS - ADD THESE OUTSIDE CONTAINER
       ======================================== -->

  <!-- Document Management Modal (THIS WAS MISSING!) -->
  <div id="docModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#2c2c2c; padding:30px; border-radius:8px; width:90%; max-width:500px; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
      <h3 id="docModalTitle" style="margin-top:0; color:#4CAF50;">Add Document</h3>
      
      <label style="display:block; margin-bottom:5px; color:#bdbdbd;">Document Name:</label>
      <input type="text" id="doc_name_input" placeholder="e.g., Bank Statement" 
             style="width:95%; padding:10px; margin-bottom:15px; border:1px solid #444; border-radius:4px; background:#1e1e1e; color:#fff;">
      
      <label style="display:block; margin-bottom:5px; color:#bdbdbd;">
        Search Pattern:
        <span style="font-size:0.85em; color:#888;">
          (Use | for OR, comma for AND. Example: "bank_statement|bank statement,copy")
        </span>
      </label>
      <input type="text" id="doc_pattern_input" placeholder="loan,statement or loan_statement|loan statement" 
             style="width:95%; padding:10px; margin-bottom:20px; border:1px solid #444; border-radius:4px; background:#1e1e1e; color:#fff;">
      
      <div style="text-align:right;">
        <button onclick="closeDocModal()" style="padding:10px 20px; margin-right:10px; background:#757575; border:none; border-radius:4px; color:#fff; cursor:pointer;">Cancel</button>
        <button onclick="saveDocument()" style="padding:10px 20px; background:#4CAF50; border:none; border-radius:4px; color:#fff; cursor:pointer;">Save</button>
      </div>
    </div>
  </div>

  <!-- Email Modal (Before Run) -->
  <div id="emailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#2c2c2c; padding:30px; border-radius:8px; width:90%; max-width:600px; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
      <h3 style="margin-top:0; color:#4CAF50;">Send Report via Email</h3>
      
      <label style="display:block; margin-bottom:5px; color:#bdbdbd;">Recipient Email(s) *</label>
      <input type="text" id="email_input" placeholder="recipient@example.com, another@example.com" 
             style="width:95%; padding:10px; margin-bottom:15px; border:1px solid #444; border-radius:4px; background:#1e1e1e; color:#fff;">
      
      <label style="display:block; margin-bottom:5px; color:#bdbdbd;">CC (Optional)</label>
      <input type="text" id="cc_input" placeholder="cc@example.com" 
             style="width:95%; padding:10px; margin-bottom:15px; border:1px solid #444; border-radius:4px; background:#1e1e1e; color:#fff;">
      
      <label style="display:block; margin-bottom:5px; color:#bdbdbd;">Subject</label>
      <input type="text" id="subject_input" value="Automated Report" 
             style="width:95%; padding:10px; margin-bottom:15px; border:1px solid #444; border-radius:4px; background:#1e1e1e; color:#fff;">
      
      <label style="display:block; margin-bottom:5px; color:#bdbdbd;">Message</label>
      <textarea id="message_input" rows="4" placeholder="Please find attached the automated report." 
                style="width:95%; padding:10px; margin-bottom:20px; border:1px solid #444; border-radius:4px; background:#1e1e1e; color:#fff; resize:vertical;"></textarea>
      
      <div style="text-align:right;">
        <button onclick="closeEmailModal()" style="padding:10px 20px; margin-right:10px; background:#757575; border:none; border-radius:4px; color:#fff; cursor:pointer;">Cancel</button>
        <button onclick="startProcessAfterEmail()" style="padding:10px 20px; background:#4CAF50; border:none; border-radius:4px; color:#fff; cursor:pointer;">Start Process</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" style="display:none; position:fixed; bottom:20px; right:20px; padding:15px 25px; background:#27ae60; color:#fff; border-radius:4px; z-index:2000; box-shadow:0 4px 12px rgba(0,0,0,0.3);"></div>

  <script>
    let GENERATED_REPORT_FILENAME = "";
  </script>
  <script src="{{ url_for('static', filename='script.js') }}"></script>

</body>
</html>
